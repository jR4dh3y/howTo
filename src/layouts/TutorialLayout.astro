---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Giscus from '../components/Giscus.astro';
import { Copy, Check, ArrowLeft } from '@lucide/astro';
import { extractVideoId, getEmbedUrl } from '../utils/youtube';

interface Props {
	title: string;
	description: string;
	date: Date;
	headings: { depth: number; slug: string; text: string }[];
	youtubeUrl?: string;
}

const { title, description, date, headings, youtubeUrl } = Astro.props;

const formattedDate = date.toLocaleDateString("en-US", {
	year: "numeric",
	month: "long",
	day: "numeric",
});

const videoId = youtubeUrl ? extractVideoId(youtubeUrl) : null;
const embedUrl = videoId ? getEmbedUrl(videoId) : null;
---

<BaseLayout title={`${title} | HowTo`} description={description}>
	<Header />
	<main class="pt-24 pb-16 px-6">
		<div class="max-w-6xl mx-auto">
			<div class="grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-12">
				<article class="min-w-0">
					<header class="mb-10">
						<div class="flex items-center gap-3 mb-2">
							<a
								href="/"
								class="p-2 rounded-lg bg-[var(--surface)] border border-[var(--border)] text-[var(--fg)] transition-all duration-200 hover:border-[var(--accent)] hover:text-[var(--accent)]"
								aria-label="Back to home"
							>
								<ArrowLeft class="w-4 h-4" />
							</a>
							<time class="text-sm uppercase tracking-widest text-[var(--muted)] font-medium">
								{formattedDate}
							</time>
						</div>
						<h1 class="text-4xl md:text-5xl mt-3 mb-4 text-[var(--accent)] text-balance leading-tight" style="font-family: var(--font-display);">
							{title}
						</h1>
						<p class="text-lg text-[var(--muted)] leading-relaxed">
							{description}
						</p>
						{embedUrl && (
							<div class="mt-6 aspect-video rounded-lg overflow-hidden border border-[var(--border)]">
								<iframe
									src={embedUrl}
									title="YouTube video player"
									allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
									allowfullscreen
									class="w-full h-full"
								></iframe>
							</div>
						)}
					</header>
					<div class="prose">
						<slot />
					</div>
					<Giscus />
				</article>
				<aside class="hidden xl:block self-start sticky top-24">
					<TableOfContents headings={headings} />
				</aside>
			</div>
		</div>
	</main>

	<!-- Hidden icon templates for copy button -->
	<template id="copy-icon-template">
		<Copy class="w-4 h-4" />
	</template>
	<template id="check-icon-template">
		<Check class="w-4 h-4" />
	</template>
</BaseLayout>

<style is:global>
	/* Force heading colors in markdown content */
	.prose h1,
	.prose h2,
	.prose h3,
	.prose h4,
	.prose h5,
	.prose h6 {
		color: #c59edc !important;
	}
</style>

<script>
	// Add copy buttons to all code blocks
	document.addEventListener('DOMContentLoaded', () => {
		const codeBlocks = document.querySelectorAll('.prose pre');
		const copyTemplate = document.getElementById('copy-icon-template') as HTMLTemplateElement | null;
		const checkTemplate = document.getElementById('check-icon-template') as HTMLTemplateElement | null;

		codeBlocks.forEach((pre) => {
			// Add relative positioning and group class to pre for hover effects
			pre.classList.add('relative', 'group');
			
			const button = document.createElement('button');
			button.className = 'copy-button absolute top-2 right-2 p-2 bg-[var(--border)] border border-[var(--border)] rounded-md text-[var(--muted)] cursor-pointer opacity-0 transition-all duration-200 hover:bg-[var(--muted)] hover:border-[var(--muted)] hover:text-[var(--background)] group-hover:opacity-100 flex items-center justify-center';
			button.setAttribute('aria-label', 'Copy code');
			
			// Clone the copy icon from template
			if (copyTemplate) {
				button.appendChild(copyTemplate.content.cloneNode(true));
			}

			button.addEventListener('click', async () => {
				const code = pre.querySelector('code');
				if (code) {
					try {
						await navigator.clipboard.writeText(code.textContent || '');
						button.classList.add('text-green-500');
						button.innerHTML = '';
						
						// Clone the check icon from template
						if (checkTemplate) {
							button.appendChild(checkTemplate.content.cloneNode(true));
						}
						
						button.setAttribute('aria-label', 'Copied!');

						setTimeout(() => {
							button.classList.remove('text-green-500');
							button.innerHTML = '';
							
							// Clone the copy icon from template
							if (copyTemplate) {
								button.appendChild(copyTemplate.content.cloneNode(true));
							}
							
							button.setAttribute('aria-label', 'Copy code');
						}, 2000);
					} catch (err) {
						console.error('Failed to copy code:', err);
					}
				}
			});

			pre.appendChild(button);
		});
	});
</script>
