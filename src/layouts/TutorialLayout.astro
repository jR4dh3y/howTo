---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Giscus from '../components/Giscus.astro';

interface Props {
	title: string;
	description: string;
	date: Date;
	headings: { depth: number; slug: string; text: string }[];
}

const { title, description, date, headings } = Astro.props;

const formattedDate = date.toLocaleDateString("en-US", {
	year: "numeric",
	month: "long",
	day: "numeric",
});
---

<BaseLayout title={`${title} | HowTo`} description={description}>
	<Header />
	<main class="pt-24 pb-16 px-6">
		<div class="max-w-6xl mx-auto">
			<div class="grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-12">
				<article class="min-w-0">
					<header class="mb-10">
						<time class="text-sm uppercase tracking-widest text-[var(--muted)] font-medium">
							{formattedDate}
						</time>
						<h1 class="text-4xl md:text-5xl mt-3 mb-4 text-[var(--accent)] text-balance leading-tight" style="font-family: var(--font-display);">
							{title}
						</h1>
						<p class="text-lg text-[var(--muted)] leading-relaxed">
							{description}
						</p>
					</header>
					<div class="prose">
						<slot />
					</div>
					<Giscus />
				</article>
				<aside class="hidden xl:block self-start sticky top-24">
					<TableOfContents headings={headings} />
				</aside>
			</div>
		</div>
	</main>
</BaseLayout>

<style is:global>
	/* Force heading colors in markdown content */
	.prose h1,
	.prose h2,
	.prose h3,
	.prose h4,
	.prose h5,
	.prose h6 {
		color: #c59edc !important;
	}

	/* Code block copy button styles */
	.prose pre {
		position: relative;
	}

	.prose pre .copy-button {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		padding: 0.5rem;
		background: var(--border);
		border: 1px solid var(--border);
		border-radius: 0.375rem;
		color: var(--muted);
		cursor: pointer;
		opacity: 0;
		transition: opacity 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.prose pre:hover .copy-button {
		opacity: 1;
	}

	.prose pre .copy-button:hover {
		background: var(--muted);
		border-color: var(--muted);
		color: var(--background);
	}

	.prose pre .copy-button.copied {
		color: #22c55e;
	}
</style>

<script>
	// Add copy buttons to all code blocks
	document.addEventListener('DOMContentLoaded', () => {
		const codeBlocks = document.querySelectorAll('.prose pre');

		codeBlocks.forEach((pre) => {
			const button = document.createElement('button');
			button.className = 'copy-button';
			button.setAttribute('aria-label', 'Copy code');
			button.innerHTML = `
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
					<path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
				</svg>
			`;

			button.addEventListener('click', async () => {
				const code = pre.querySelector('code');
				if (code) {
					try {
						await navigator.clipboard.writeText(code.textContent || '');
						button.classList.add('copied');
						button.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<polyline points="20 6 9 17 4 12"/>
							</svg>
						`;
						button.setAttribute('aria-label', 'Copied!');

						setTimeout(() => {
							button.classList.remove('copied');
							button.innerHTML = `
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
									<path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
								</svg>
							`;
							button.setAttribute('aria-label', 'Copy code');
						}, 2000);
					} catch (err) {
						console.error('Failed to copy code:', err);
					}
				}
			});

			pre.appendChild(button);
		});
	});
</script>
