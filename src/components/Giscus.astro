---
import { MessageSquare, RefreshCw } from '@lucide/astro';

const repo = import.meta.env.GISCUS_REPO || "";
const repoId = import.meta.env.GISCUS_REPO_ID || "";
const category = import.meta.env.GISCUS_CATEGORY || "General";
const categoryId = import.meta.env.GISCUS_CATEGORY_ID || "";
---

<div class="mt-16 pt-8 border-t border-[var(--border)]">
	<div class="flex items-center justify-between mb-6">
		<div class="flex items-center gap-3">
			<MessageSquare class="w-5 h-5 text-[var(--accent)]" />
			<h3 class="text-lg font-medium text-[var(--fg)]" style="font-family: var(--font-display);">Comments</h3>
		</div>
		<button 
			id="refresh-comments" 
			class="flex items-center justify-center p-2 rounded-lg bg-[var(--surface)] border border-[var(--border)] text-[var(--muted)] cursor-pointer transition-all duration-200 hover:border-[var(--accent)] hover:text-[var(--accent)] hover:bg-[var(--bg)]"
			aria-label="Refresh comments"
			title="Refresh comments"
		>
			<RefreshCw class="w-4 h-4" id="refresh-icon" />
		</button>
	</div>
	<div class="bg-[var(--surface)] border border-[var(--border)] rounded-xl p-6 transition-colors duration-200 hover:border-[var(--accent)]">
		<div class="giscus w-full"></div>
	</div>
</div>

<script 
	src="https://giscus.app/client.js"
	data-repo={repo}
	data-repo-id={repoId}
	data-category={category}
	data-category-id={categoryId}
	data-mapping="pathname"
	data-strict="0"
	data-reactions-enabled="0"
	data-emit-metadata="1"
	data-input-position="bottom"
	data-theme="preferred_color_scheme"
	data-lang="en"
	crossorigin="anonymous"
	async
></script>

<script>
	let lastCommentCount = 0;
	
	function updateGiscusTheme() {
		const iframe = document.querySelector("iframe.giscus-frame");
		if (!iframe || !(iframe instanceof HTMLIFrameElement)) return;

		const isDark = document.documentElement.classList.contains("dark");
		const theme = isDark ? "dark" : "light";

		iframe.contentWindow?.postMessage(
			{ giscus: { setConfig: { theme } } },
			"https://giscus.app"
		);
	}

	function reloadGiscus() {
		const existingScript = document.querySelector('script[src="https://giscus.app/client.js"]');
		if (existingScript) {
			existingScript.remove();
		}
		
		const existingIframe = document.querySelector("iframe.giscus-frame");
		if (existingIframe) {
			existingIframe.remove();
		}
		
		const container = document.querySelector(".giscus");
		if (!container) return;
		
		const newScript = document.createElement("script");
		newScript.src = "https://giscus.app/client.js";
		newScript.setAttribute("data-repo", "jr4dh3y/howto");
		newScript.setAttribute("data-repo-id", "R_kgDON4k1kA");
		newScript.setAttribute("data-category", "General");
		newScript.setAttribute("data-category-id", "DIC_kwDON4k1kM4CnGlB");
		newScript.setAttribute("data-mapping", "pathname");
		newScript.setAttribute("data-strict", "0");
		newScript.setAttribute("data-reactions-enabled", "0");
		newScript.setAttribute("data-emit-metadata", "1");
		newScript.setAttribute("data-input-position", "bottom");
		newScript.setAttribute("data-theme", "preferred_color_scheme");
		newScript.setAttribute("data-lang", "en");
		newScript.setAttribute("crossorigin", "anonymous");
		newScript.async = true;
		
		document.body.appendChild(newScript);
		
		setTimeout(updateGiscusTheme, 1000);
	}

	document.addEventListener("DOMContentLoaded", () => {
		setTimeout(updateGiscusTheme, 1000);
		
		const refreshBtn = document.getElementById("refresh-comments");
		const refreshIcon = document.getElementById("refresh-icon");
		refreshBtn?.addEventListener("click", () => {
			refreshIcon?.classList.add("animate-spin");
			reloadGiscus();
			setTimeout(() => {
				refreshIcon?.classList.remove("animate-spin");
			}, 1000);
		});
	});

	const toggle = document.getElementById("theme-toggle");
	toggle?.addEventListener("click", () => {
		setTimeout(updateGiscusTheme, 100);
	});

	window.addEventListener("message", (event) => {
		if (event.origin !== "https://giscus.app") return;
		
		if (event.data?.giscus?.discussion) {
			updateGiscusTheme();
			
			const commentCount = event.data.giscus.discussion.totalCommentCount || 0;
			if (commentCount > lastCommentCount && lastCommentCount > 0) {
				setTimeout(reloadGiscus, 2000);
			}
			lastCommentCount = commentCount;
		}
		
		if (event.data?.giscus?.commentCreated) {
			setTimeout(reloadGiscus, 1500);
		}
	});
</script>

<style>
	.giscus-frame {
		border: none;
		width: 100%;
	}
</style>
